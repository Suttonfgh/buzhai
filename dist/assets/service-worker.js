import{r as d,a as h}from"./storage.js";async function m(n){return n.trim()?{alternatives:[]}:{alternatives:[]}}const g=["stupid","idiot","always","never"];function S(n){const a=n.toLowerCase();if(!a.trim())return 0;let t=0;for(const e of g)a.includes(e)&&(t+=1);return Math.min(100,t*25)}const k=60*1e3,f=new Map;function C(n){try{return JSON.stringify(n)}catch{return String(Date.now())}}chrome.runtime.onInstalled.addListener(()=>{var n;(n=chrome.storage)!=null&&n.sync&&chrome.storage.sync.get(["onboardingCompleted"],a=>{if(!a.onboardingCompleted){const t=chrome.runtime.getURL("src/ui/onboarding/index.html");chrome.tabs.create({url:t})}})});chrome.runtime.onMessage.addListener((n,a,t)=>{var i;const e=n;if(e.type==="quickCheck"){const r=S(e.text);return t({severity:r}),!1}if(e.type==="deepAnalysis")return m(e.text).then(r=>t(r)).catch(r=>t({error:String(r)})),!0;if(e.type==="backendAnalyze"){const{backendUrl:r,payload:l,apiKey:s}=e,u=C(l),c=f.get(u);if(c&&c.expiresAt>Date.now())return t({ok:!0,data:c.data,cached:!0}),!1;const y={"Content-Type":"application/json"};return s&&(y["x-api-key"]=s),fetch(`${r}/api/analyze`,{method:"POST",headers:y,body:JSON.stringify(l)}).then(async o=>{if(!o.ok)throw new Error(`HTTP ${o.status}`);return o.json()}).then(o=>{f.set(u,{expiresAt:Date.now()+k,data:o}),t({ok:!0,data:o})}).catch(o=>{console.error("[Conflict Translator SW] Backend analyze failed:",o),t({ok:!1,error:String(o)})}),!0}return e.type==="recordAnalysis"?(console.log("[Conflict Translator SW] Recording analysis:",(i=e.entry.text)==null?void 0:i.substring(0,30),"anonymousMode:",e.anonymousMode),d(e.entry,e.anonymousMode).then(()=>{console.log("[Conflict Translator SW] Analysis recorded successfully"),t({ok:!0})}).catch(r=>{console.error("[Conflict Translator SW] Failed to record analysis:",r),t({ok:!1,error:String(r)})}),!0):e.type==="recordReplacement"?(console.log("[Conflict Translator SW] Recording replacement"),h(e.beforeSeverity,e.afterSeverity).then(()=>t({ok:!0})).catch(r=>t({ok:!1,error:String(r)})),!0):!1});
